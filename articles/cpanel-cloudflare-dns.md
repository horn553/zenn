---
title: "cPanel環境下のメールサーバー認証とCloudflare DNSとの相性問題を解消する"
emoji: "📧"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["cloudflare", "cloudflaredns", "cpanel"]
publication_name: "orch_canvas"
published: false
---

## まとめ

- cPanel環境下のメールサーバー認証とCloudflare DNSとの相性問題に遭遇した
- 以下のDNSレコードを追加することで、メールサービスが正常稼働するようになった
  - `mail A <サーバーのIPアドレス>`
  - プロキシステータス：off（DNSのみ）

---

## 背景

当団（[Orchestra Canvas Tokyo](https://www.orch-canvas.tokyo/)）では、レンタルサーバーとして[ColorfulBox](https://www.colorfulbox.jp/)を利用しています。
メールサーバーとして利用しているほか、ドメインも同サービスで取得しています。
また、ColorfulBoxではサーバー管理ツールとしてcPanelが使用されています。

2025年1月ごろ、Webサイト開発の簡便化のため、Cloudflare DNSを利用するよう環境を更新する必要が生じました。
詳しい経緯はこちらの記事をご覧ください。

https://zenn.dev/orch_canvas/articles/sveltekit-cloudflare-images

## セットアップで発生した問題

前述の経緯でCloudflare DNSへの移行を決意し、セットアップを進めたところ、問題が発生しました。
順を追って説明します。

### 一見順調なCloudflare DNSのセットアップ

公式ドキュメントでオススメされている「Full setup」の手順に従い、作業を進めました。

https://developers.cloudflare.com/dns/zone-setups/

参考までに、作業ログとして利用していたスクラップのリンクも載せておきます。

https://zenn.dev/kokkosan/scraps/0c54fd44cfbe9c

Webサイトへのアクセス、メール送受信ともに明らかなダウンタイムはなく、数十分程度でセットアップが終了したように思われました。

### スマホのメーラーから送受信できない

数時間後、出先でメール送受信に問題ないことを確認しようと、スマホのメーラーを開きます。
メール送受信ともにできませんでした。

まずは公式のトラブルシューティングに従って問題の特定・解決を図りましたが、どれにもあてはまりません。

https://developers.cloudflare.com/dns/troubleshooting/email-issues/

メーラーで詳しく状況を確認すると、メールサーバーとの接続に失敗しているようでした。
セットアップ時のメール送受信機能の確認は、レンタルサーバー管理画面であるcPanel上のWebメーラーで行っていました。
もしやと改めて確認すると、Webメーラーでの送受信機能は問題なく保たれていました。

すなわち、問題は一般的なメール送受信まわりのDNSレコードでなく、**cPanel環境下でのメールサーバー認証とCloudflare DNSとの相性**ということになりました。

## 問題の解決方法

cPanelは普及したサービスですので、英語で調べると多くの情報が見つかり、同様の事例も複数報告されていました。

それらの情報をもとに次のDNSレコードを追加し、問題は数分で解消しました。

- `mail A <サーバーのIPアドレス>`
- プロキシステータス：無効（DNSのみ）

Cloudflareとしては、プロキシを有効化することを推奨しています。
IPアドレスの露出が防がれることで、攻撃可能性が下がるからです。

しかし、元々は露出していたものでありMXレコードでは露出していること、Cloudflare DNSを利用することで得られるメリットが大きいことから、上記のレコードを追加・維持することにしました。

---

## おわりに

今回の本筋ではないですが、問題の最前線を探る作業は難しいものですね。
今回で言えば、「最前線はcPanel環境下のメールサーバー認証とCloudflare DNSとの相性問題である」と推定するような作業です。

非特異的なエラーのみだったり、ログを得にくい環境だったりするとより難しい……
その最前線を探る作業に何かコツがあったり、あるいはその知見が体系的にまとまった書籍はないものなのでしょうか？
そもそも、この「最前線を探る」作業って何か名前がついていたりするものなのでしょうか？

……という問題について、その最前線を見つけていこうと思った今日この頃です。
