---
title: "【③ セッション】SvelteKit on Cloudflareでお問い合わせフォームをつくる"
emoji: "📯"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["svelte", "sveltekit", "cloudflarepages"]
publication_name: "orch_canvas"
published: true
---

私たちは [Orchestra Canvas Tokyo](https://www.orch-canvas.tokyo/) です。

弊団のホームページ、ブログのリファクタリングにおいてできた、お問い合わせフォーム実装に関する知見をまとめた本シリーズ。
今回は SvelteKit x Cloudflare KV でセッションを実装します！

<!-- begin short upcoming concert announcement -->

:::message
私たちOrchestra Canvas Tokyoは、都内を中心に活動するアマチュア・オーケストラです。

次回は2025年7月にシューマンの交響曲第2番。
初めての方も、そうでない方も、お気軽にお越しください！

詳しくは[チケット販売サービス teket](https://teket.jp/1776/47046?uid=zenn)まで。
<!-- textlint-disable -->
:::
<!-- textlint-disable -->

<!-- end short upcoming concert announcement -->

---

#### このシリーズの記事一覧

1. [① サイト作成：SvelteKit x Cloudflare Pages](https://zenn.dev/orch_canvas/articles/create-contact-form-01)
1. [② フォーム作成：SvelteKit x Zod x Google reCAPTCHA v3](https://zenn.dev/orch_canvas/articles/create-contact-form-02)
1. **③ セッション：SvelteKit x Cloudflare KV ← 今回の記事**
1. [④ データベース：SvelteKit x Cloudflare D1](https://zenn.dev/orch_canvas/articles/create-contact-form-04)
1. [⑤ メール送信：SvelteKit x Resend](https://zenn.dev/orch_canvas/articles/create-contact-form-05)

このシリーズで作成したお問い合わせフォームはこちら。
https://github.com/horn553/zenn-contact-form

---

## はじめに

お問い合わせフォームには、セッションを用意することが望ましいです。
CSRF 対策のためです。

IPA のガイドを参考に、CSRF トークンを発行し、検証するように実装します。

参考：[安全なウェブサイトの作り方 - 1.6 CSRF（クロスサイト・リクエスト・フォージェリ） | 情報セキュリティ | IPA 独立行政法人 情報処理推進機構](https://www.ipa.go.jp/security/vuln/websecurity/csrf.html)

## 技術選定

今回は、シンプルなセッション機能があれば十分です。

[svelte-kit-sessions](https://www.npmjs.com/package/svelte-kit-sessions) パッケージを用いることとします。
このパッケージは、Cloudflare が提供する Key-Value ストレージである [Cloudflare KV](https://www.cloudflare.com/ja-jp/developer-platform/products/workers-kv/) をサポートする（サブ）パッケージも開発されています。

### Cloudflare Pages x KV

Cloudflare Pages からも [Pages Functions](https://developers.cloudflare.com/pages/functions/) という機能を用いて Cloudflare KV などを呼び出すことができます。
Cloudflare Workers で Cloudflare KV を呼び出すのと似たイメージです。

やや設定は異なるようですが、「Cloudflare Workers でできることは Pages でもできる」ということです。
これは大変便利ですね！

### 費用

Cloudflare KV の無料枠は次の通りです。
参考︰[Pricing - Cloudflare Workers KV](https://developers.cloudflare.com/kv/platform/pricing/)

- 読み取り上限: 100,000 回/日
- 書き込み、削除、リスト上限: 1,000 回/日
- 容量上限: 1GB

Cloudflare Pages Functions は Workers と枠が同様です。無料枠は次の通りです。
参考：[Pricing - Cloudflare Workers](https://developers.cloudflare.com/workers/platform/pricing/#workers)

- リクエスト上限: 100,000 件/日
- CPU 時間上限: 10ms/呼び出し

今回のような、シンプルかつ頻用されないアプリケーションであれば、問題なく使える水準ではないでしょうか。

## 環境構築

### 依存関係のインストール

まずは依存関係をインストールします。

```shell
npm i svelte-kit-sessions svelte-kit-connect-cloudflare-kv
```

:::message alert
執筆時点では各種パッケージが Svelte5 をサポートしておらず、エラーとなります。
過渡期の対応として、`--force` オプション付きで実行します。

```shell
npm i --force svelte-kit-sessions svelte-kit-connect-cloudflare-kv
```

:::

### Wrangler の設定

Cloudflare Pages Functions の設定は [Wrangler](https://developers.cloudflare.com/workers/wrangler/) という CLI ツールを用いて行います。
これも Workers と一緒です。

グローバルインストールしてもいいですが、ここでは`npx` コマンドで実行します。
（好みの問題です）

ログインのうえ、現在の設定をダウンロードします。
参考：[Commands - Wrangler](https://developers.cloudflare.com/workers/wrangler/commands/#download-config)

```shell
npx wrangler login
npx wrangler pages download config zenn-contact-form
```

そうすると、ルートに `wrangler.toml` が作成されます。

```toml:/wrangler.toml
# Generated by Wrangler on Fri Nov 08 2024 18:04:42 GMT+0900 (日本標準時)
name = "zenn-contact-form"
pages_build_output_dir = ".svelte-kit/cloudflare"
compatibility_date = "2024-11-05"
```

### KV 名前空間の作成

Cloudflare ダッシュボード（GUI）で作成してもいいですが、ここでは Wrangler（CLI）で作成します。
また、この規模だとプレビュー環境と本番環境は同じでもよい気がしますが、ここではあえて異なる名前空間で管理する方法をまとめます。

攻めの姿勢です。

```shell
npx wrangler kv namespace create zenn-contact-form # （リモートの）プレビュー環境用
npx wrangler kv namespace create zenn-contact-form --preview # ローカル環境用
npx wrangler kv namespace create zenn-contact-form-production # プロダクション環境用
```

こうすると 3 つの `id` あるいは `preview_id` が生成されます。
それぞれを Wrangler の設定ファイルに反映させます。

キー `binding` の値は、SvelteKit から呼び出す際のキーの名称です。
プロジェクト内で一意であればよいので、`KV` とします。

```diff toml:/wrangler.toml
  # Generated by Wrangler on Fri Nov 08 2024 18:04:42 GMT+0900 (日本標準時)
  name = "zenn-contact-form"
  pages_build_output_dir = ".svelte-kit/cloudflare"
  compatibility_date = "2024-11-05"
+
+ # ローカル環境
+ [[kv_namespaces]]
+ binding = "KV"
+ id = "6653db06adad47b39dd539b60abe5e6c"
+ preview_id = "6653db06adad47b39dd539b60abe5e6c"
+
+ # プレビュー環境
+ [[env.preview.kv_namespaces]]
+ binding = "KV"
+ id = "95ae2b54ae2f4977a23f144e2eb575ef"
+
+ [[env.production.kv_namespaces]]
+ binding = "KV"
+ id = "353de8673ca54e078cfdc52b6735947c"
```

### .gitignore の更新

Wrangler のキャッシュなどを ignore します。

```diff ini:/.gitignore
+ # wrangler
+ /.wrangler
```

### SvelteKit の設定

`KV` がバインドされていることを明示します。

```diff ts:/src/app.d.ts
  // See https://kit.svelte.dev/docs/types#app
  // for information about these interfaces
  declare global {
    namespace App {
      // interface Error {}
      // interface Locals {}
      // interface PageData {}
      // interface PageState {}
-     // interface Platform {}
+     interface Platform {
+       env: {
+         KV: KVNamespace;
+       };
+     }
    }
  }

  export {};
```

環境構築は以上です！

## サーバーサイドの実装

### セッションの初期化

パッケージ `svelte-kit-sessions` のガイドに従い、hook としてセッションの初期化処理を記述します。
SvelteKit では、リクエストに関連するイベント処理を [hooks](https://svelte.dev/docs/kit/hooks) と呼びます。

ここでは、hooks のうちリクエスト時に呼び出される handle を利用します。

```ts:/src/hooks.server.ts
import type { Handle } from '@sveltejs/kit';
import { sveltekitSessionHandle } from 'svelte-kit-sessions';
import KvStore from 'svelte-kit-connect-cloudflare-kv';
import type { Store } from 'svelte-kit-sessions';

declare module 'svelte-kit-sessions' {
  interface SessionData {
    csrfToken: string;
  }
}

export const handle: Handle = async ({ event, resolve }) => {
  let sessionHandle: Handle | null = null;

  if (event.platform && event.platform.env) {
    // https://kit.svelte.dev/docs/adapter-cloudflare#bindings
    const store = new KvStore({ client: event.platform.env.KV }) as Store;
    sessionHandle = sveltekitSessionHandle({
      secret: 'secret',
      store
    });
  }

  return sessionHandle ? sessionHandle({ event, resolve }) : resolve(event);
};
```

:::message
型に関するエラーが出る場合、SvelteKit が自動生成する型が生成されていないことに起因する場合があります。

`npm run dev` を走らせておく、`npm run build` を単回実行するなどで型定義ファイルが更新され、エラーが解消します。

:::

### CSRF トークンの生成

`/contact` へのリクエスト時、生成するようにします。

```diff ts:/src/routes/contact/+page.server.ts（抜粋）
- export const load: PageServerLoad = async () => {
+ export const load: PageServerLoad = async ({ locals }) => {
+   const { session } = locals;
+   await session.setData({
+     csrfToken: crypto.randomUUID()
+   });
+   await session.save();
+
    return {
      NAME_MAX_LENGTH,
      EMAIL_MAX_LENGTH,
      CATEGORY_OPTIONS,
-     BODY_MAX_LENGTH
+     BODY_MAX_LENGTH,
+     csrfToken: session.data.csrfToken
+   };
+ };
```

`session.save()` を実行することを忘れないようにしないといけません！(1 敗)

### schema の更新

もちろん CSRF トークンはクライアントサイドからのリクエストボディに含まれます。

```diff ts:/src/routes/contact/schema.ts（抜粋）
  export const requestBodySchema = z.object({
    name: z.string().max(NAME_MAX_LENGTH),
    email: z.string().email().max(EMAIL_MAX_LENGTH),
    category: z.enum(categoryKeys),
    body: z.string().max(BODY_MAX_LENGTH),
+   csrfToken: z.string(),
    reCaptchaToken: z.string()
  });
```

### CSRF トークンの検証

検証に関するロジックも記述しておきます。

```diff ts:/src/routes/contact/+page.server.ts（抜粋）
  export const actions = {
-   default: async ({ request }) => {
+   default: async ({ locals, request }) => {
+     const { session } = locals;
      const rawRequestBody = convertToObject(await request.formData());

      // バリデーションをかける
      const validationResult = requestBodySchema.safeParse(rawRequestBody);
      if (!validationResult.success) {
        return { success: false, message: 'Invalid request body' };
      }
      const requestBody = validationResult.data;
+
+     // CSRFトークンを検証
+     const csrfResult = requestBody.csrfToken === session.data.csrfToken;
+     if (!csrfResult) {
+       return { success: false, message: 'Invalid CSRF token' };
+     }

      // reCAPTCHAを検証
      const captchaResult = verifyCaptcha(requestBody.reCaptchaToken);
      if (!captchaResult) {
        return { success: false, message: 'Invalid CAPTCHA token' };
      }

      return { success: true };
    }
  } satisfies Actions;
```

## クライアントサイドの実装

受け取ったトークンを、hidden な input に入れておくだけです。

```diff html:/src/routes/conact/+page.svelte（抜粋）
    <label>
      本文
      <textarea name="body" maxLength={data.BODY_MAX_LENGTH} disabled={isSubmitting}></textarea>
    </label>
+   <input name="csrfToken" type="hidden" value={data.csrfToken} />
    <button type="submit" disabled={isSubmitting}>送信</button>
```

### prerender の解除

セッションを利用しているため、prerender はできません。

```diff ts:/src/routes/+page.ts
- export const prerender = true;
```

```diff ts:/src/routes/about/+page.ts
- export const prerender = true;
```

```diff ts:/src/routes/sverdle/how-to-play/+page.ts
- export const prerender = true;
```

```diff ts:/src/routes/+layout.ts
+ export const prerender = false; // すべてのエンドポイントを一括指定
```

## 検証

### ローカル環境

Cloudflare KV は Wrangler がローカルでエミュレートしてくれます。
そのため、SvelteKit が Vite を用いて実行している `npm run dev` は利用できません。

一度ビルドし、Wrangler に実行してもらう必要があります。

```shell
npm run build
npx wrangler pages dev ./.svelte-kit/cloudflare/
```

きちんと CSRF トークンがクライアントサイドに渡され、input に格納されています！

![クライアントサイドとデベロッパーツールのスクリーンショット](/images/create-contact-form-03/01.png)

送信すると、CSRF トークンの検証に成功し、`success: true` が返されたため、フォームが初期化されました。

### プレビュー環境、プロダクション環境

これをデプロイすると、それぞれの環境でそれぞれの環境の KV に接続し動作します。
一方で、それぞれの環境の中では同一の KV に接続するため、過去のデプロイで作成・編集したデータを引き継ぎます。

Cloudflare ダッシュボードから KV のページに行き、各名前空間の内容を直接見て確認できます。
Wrangler 経由でも確認できます。

## おわりに

たったこれだけで Key-Value ストレージ と接続できてしまう！なんと便利な時代なのでしょうか。

次回の Cloudflare D1 も基本的な連携方法は同じです。
ORM も交わる、より深く便利な世界へ進んでいきます！

---

1. [① サイト作成：SvelteKit x Cloudflare Pages](https://zenn.dev/orch_canvas/articles/create-contact-form-01)
1. [② フォーム作成：SvelteKit x Zod x Google reCAPTCHA v3](https://zenn.dev/orch_canvas/articles/create-contact-form-02)
1. ③ セッション管理：SvelteKit x Cloudflare KV
1. **[④ データベース管理：SvelteKit x Cloudflare D1 ← 次の記事](https://zenn.dev/orch_canvas/articles/create-contact-form-04)**
1. [⑤ メール送信：SvelteKit x Resend](https://zenn.dev/orch_canvas/articles/create-contact-form-05)

---

<!-- begin long upcoming concert announcement -->

## 次回演奏会のご案内

Orchestra Canvas Tokyoは、都内を中心に活動するアマチュアオーケストラです。

日々の癒しに、新たなひらめきのきっかけに——
オーケストラの演奏会はいかがでしょうか？

初めての方も大歓迎！
ご来場をお待ちしています。

> **Orchestra Canvas Tokyo**
> **第14回定期演奏会**
>
> 2025年7月12日(土)
> 練馬区立練馬文化センター 大ホール
> シューマン / 交響曲第2番 ほか
>
> [![](/images/regular-14.png =250x)](https://www.orch-canvas.tokyo/concerts/regular-14)
>
> 詳細は[チケット販売サービス teket](https://teket.jp/1776/47046?uid=zenn)にて

<!-- end long upcoming concert announcement -->
