---
title: "ã€â‘¢ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€‘SvelteKit on Cloudflareã§ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã¤ãã‚‹"
emoji: "ğŸ“¯"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["svelte", "sveltekit", "cloudflarepages"]
publication_name: "orch_canvas"
published: true
---

ç§ãŸã¡ã¯ [Orchestra Canvas Tokyo](https://www.orch-canvas.tokyo/) ã§ã™ã€‚

å¼Šå›£ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã€ãƒ–ãƒ­ã‚°ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã«ãŠã„ã¦ã§ããŸã€ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ å®Ÿè£…ã«é–¢ã™ã‚‹çŸ¥è¦‹ã‚’ã¾ã¨ã‚ãŸæœ¬ã‚·ãƒªãƒ¼ã‚ºã€‚
ä»Šå›ã¯ SvelteKit x Cloudflare KV ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¾ã™ï¼

<!-- begin short upcoming concert announcement -->

> ç§ãŸã¡Orchestra Canvas Tokyoã¯ã€éƒ½å†…ã‚’ä¸­å¿ƒã«æ´»å‹•ã™ã‚‹ã‚¢ãƒãƒãƒ¥ã‚¢ãƒ»ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©ã§ã™ã€‚
>
> æ¬¡å›ã¯2026å¹´3æœˆã«ãƒãƒ¼ãƒ³ã‚¹ã‚¿ã‚¤ãƒ³ã®ã‚·ãƒ³ãƒ•ã‚©ãƒ‹ãƒƒã‚¯ãƒ€ãƒ³ã‚¹ã€‚
> åˆã‚ã¦ã®æ–¹ã‚‚ã€ãã†ã§ãªã„æ–¹ã‚‚ã€ãŠæ°—è»½ã«ãŠè¶Šã—ãã ã•ã„ï¼
>
> è©³ã—ãã¯[ãƒã‚±ãƒƒãƒˆè²©å£²ãƒšãƒ¼ã‚¸](https://teket.jp/1776/59938?uid=zenn)ã¾ã§ã€‚

<!-- end short upcoming concert announcement -->

---

#### ã“ã®ã‚·ãƒªãƒ¼ã‚ºã®è¨˜äº‹ä¸€è¦§

1. [â‘  ã‚µã‚¤ãƒˆä½œæˆï¼šSvelteKit x Cloudflare Pages](https://zenn.dev/orch_canvas/articles/create-contact-form-01)
1. [â‘¡ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆï¼šSvelteKit x Zod x Google reCAPTCHA v3](https://zenn.dev/orch_canvas/articles/create-contact-form-02)
1. **â‘¢ ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼šSvelteKit x Cloudflare KV â† ä»Šå›ã®è¨˜äº‹**
1. [â‘£ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼šSvelteKit x Cloudflare D1](https://zenn.dev/orch_canvas/articles/create-contact-form-04)
1. [â‘¤ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼šSvelteKit x Resend](https://zenn.dev/orch_canvas/articles/create-contact-form-05)

ã“ã®ã‚·ãƒªãƒ¼ã‚ºã§ä½œæˆã—ãŸãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã¯ã“ã¡ã‚‰ã€‚
https://github.com/horn553/zenn-contact-form

---

## ã¯ã˜ã‚ã«

ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã«ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”¨æ„ã™ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã§ã™ã€‚
CSRF å¯¾ç­–ã®ãŸã‚ã§ã™ã€‚

IPA ã®ã‚¬ã‚¤ãƒ‰ã‚’å‚è€ƒã«ã€CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã€æ¤œè¨¼ã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚

å‚è€ƒï¼š[å®‰å…¨ãªã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®ä½œã‚Šæ–¹ - 1.6 CSRFï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªï¼‰ | æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | IPA ç‹¬ç«‹è¡Œæ”¿æ³•äºº æƒ…å ±å‡¦ç†æ¨é€²æ©Ÿæ§‹](https://www.ipa.go.jp/security/vuln/websecurity/csrf.html)

## æŠ€è¡“é¸å®š

ä»Šå›ã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ãªã‚»ãƒƒã‚·ãƒ§ãƒ³æ©Ÿèƒ½ãŒã‚ã‚Œã°ååˆ†ã§ã™ã€‚

[svelte-kit-sessions](https://www.npmjs.com/package/svelte-kit-sessions) ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç”¨ã„ã‚‹ã“ã¨ã¨ã—ã¾ã™ã€‚
ã“ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ã€Cloudflare ãŒæä¾›ã™ã‚‹ Key-Value ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§ã‚ã‚‹ [Cloudflare KV](https://www.cloudflare.com/ja-jp/developer-platform/products/workers-kv/) ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ï¼ˆã‚µãƒ–ï¼‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚é–‹ç™ºã•ã‚Œã¦ã„ã¾ã™ã€‚

### Cloudflare Pages x KV

Cloudflare Pages ã‹ã‚‰ã‚‚ [Pages Functions](https://developers.cloudflare.com/pages/functions/) ã¨ã„ã†æ©Ÿèƒ½ã‚’ç”¨ã„ã¦ Cloudflare KV ãªã©ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚
Cloudflare Workers ã§ Cloudflare KV ã‚’å‘¼ã³å‡ºã™ã®ã¨ä¼¼ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

ã‚„ã‚„è¨­å®šã¯ç•°ãªã‚‹ã‚ˆã†ã§ã™ãŒã€ã€ŒCloudflare Workers ã§ã§ãã‚‹ã“ã¨ã¯ Pages ã§ã‚‚ã§ãã‚‹ã€ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ã“ã‚Œã¯å¤§å¤‰ä¾¿åˆ©ã§ã™ã­ï¼

### è²»ç”¨

Cloudflare KV ã®ç„¡æ–™æ ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚
å‚è€ƒï¸°[Pricing - Cloudflare Workers KV](https://developers.cloudflare.com/kv/platform/pricing/)

- èª­ã¿å–ã‚Šä¸Šé™: 100,000 å›/æ—¥
- æ›¸ãè¾¼ã¿ã€å‰Šé™¤ã€ãƒªã‚¹ãƒˆä¸Šé™: 1,000 å›/æ—¥
- å®¹é‡ä¸Šé™: 1GB

Cloudflare Pages Functions ã¯ Workers ã¨æ ãŒåŒæ§˜ã§ã™ã€‚ç„¡æ–™æ ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚
å‚è€ƒï¼š[Pricing - Cloudflare Workers](https://developers.cloudflare.com/workers/platform/pricing/#workers)

- ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸Šé™: 100,000 ä»¶/æ—¥
- CPU æ™‚é–“ä¸Šé™: 10ms/å‘¼ã³å‡ºã—

ä»Šå›ã®ã‚ˆã†ãªã€ã‚·ãƒ³ãƒ—ãƒ«ã‹ã¤é »ç”¨ã•ã‚Œãªã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚ã‚Œã°ã€å•é¡Œãªãä½¿ãˆã‚‹æ°´æº–ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

## ç’°å¢ƒæ§‹ç¯‰

### ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã¾ãšã¯ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```shell
npm i svelte-kit-sessions svelte-kit-connect-cloudflare-kv
```

:::message alert
åŸ·ç­†æ™‚ç‚¹ã§ã¯å„ç¨®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒ Svelte5 ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãŠã‚‰ãšã€ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚
éæ¸¡æœŸã®å¯¾å¿œã¨ã—ã¦ã€`--force` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ãã§å®Ÿè¡Œã—ã¾ã™ã€‚

```shell
npm i --force svelte-kit-sessions svelte-kit-connect-cloudflare-kv
```

:::

### Wrangler ã®è¨­å®š

Cloudflare Pages Functions ã®è¨­å®šã¯ [Wrangler](https://developers.cloudflare.com/workers/wrangler/) ã¨ã„ã† CLI ãƒ„ãƒ¼ãƒ«ã‚’ç”¨ã„ã¦è¡Œã„ã¾ã™ã€‚
ã“ã‚Œã‚‚ Workers ã¨ä¸€ç·’ã§ã™ã€‚

ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚‚ã„ã„ã§ã™ãŒã€ã“ã“ã§ã¯`npx` ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™ã€‚
ï¼ˆå¥½ã¿ã®å•é¡Œã§ã™ï¼‰

ãƒ­ã‚°ã‚¤ãƒ³ã®ã†ãˆã€ç¾åœ¨ã®è¨­å®šã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
å‚è€ƒï¼š[Commands - Wrangler](https://developers.cloudflare.com/workers/wrangler/commands/#download-config)

```shell
npx wrangler login
npx wrangler pages download config zenn-contact-form
```

ãã†ã™ã‚‹ã¨ã€ãƒ«ãƒ¼ãƒˆã« `wrangler.toml` ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

```toml:/wrangler.toml
# Generated by Wrangler on Fri Nov 08 2024 18:04:42 GMT+0900 (æ—¥æœ¬æ¨™æº–æ™‚)
name = "zenn-contact-form"
pages_build_output_dir = ".svelte-kit/cloudflare"
compatibility_date = "2024-11-05"
```

### KV åå‰ç©ºé–“ã®ä½œæˆ

Cloudflare ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆGUIï¼‰ã§ä½œæˆã—ã¦ã‚‚ã„ã„ã§ã™ãŒã€ã“ã“ã§ã¯ Wranglerï¼ˆCLIï¼‰ã§ä½œæˆã—ã¾ã™ã€‚
ã¾ãŸã€ã“ã®è¦æ¨¡ã ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã¯åŒã˜ã§ã‚‚ã‚ˆã„æ°—ãŒã—ã¾ã™ãŒã€ã“ã“ã§ã¯ã‚ãˆã¦ç•°ãªã‚‹åå‰ç©ºé–“ã§ç®¡ç†ã™ã‚‹æ–¹æ³•ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

æ”»ã‚ã®å§¿å‹¢ã§ã™ã€‚

```shell
npx wrangler kv namespace create zenn-contact-form # ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆã®ï¼‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒç”¨
npx wrangler kv namespace create zenn-contact-form --preview # ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒç”¨
npx wrangler kv namespace create zenn-contact-form-production # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒç”¨
```

ã“ã†ã™ã‚‹ã¨ 3 ã¤ã® `id` ã‚ã‚‹ã„ã¯ `preview_id` ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
ãã‚Œãã‚Œã‚’ Wrangler ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«åæ˜ ã•ã›ã¾ã™ã€‚

ã‚­ãƒ¼ `binding` ã®å€¤ã¯ã€SvelteKit ã‹ã‚‰å‘¼ã³å‡ºã™éš›ã®ã‚­ãƒ¼ã®åç§°ã§ã™ã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã§ä¸€æ„ã§ã‚ã‚Œã°ã‚ˆã„ã®ã§ã€`KV` ã¨ã—ã¾ã™ã€‚

```diff toml:/wrangler.toml
  # Generated by Wrangler on Fri Nov 08 2024 18:04:42 GMT+0900 (æ—¥æœ¬æ¨™æº–æ™‚)
  name = "zenn-contact-form"
  pages_build_output_dir = ".svelte-kit/cloudflare"
  compatibility_date = "2024-11-05"
+
+ # ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ
+ [[kv_namespaces]]
+ binding = "KV"
+ id = "6653db06adad47b39dd539b60abe5e6c"
+ preview_id = "6653db06adad47b39dd539b60abe5e6c"
+
+ # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ
+ [[env.preview.kv_namespaces]]
+ binding = "KV"
+ id = "95ae2b54ae2f4977a23f144e2eb575ef"
+
+ [[env.production.kv_namespaces]]
+ binding = "KV"
+ id = "353de8673ca54e078cfdc52b6735947c"
```

### .gitignore ã®æ›´æ–°

Wrangler ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã©ã‚’ ignore ã—ã¾ã™ã€‚

```diff ini:/.gitignore
+ # wrangler
+ /.wrangler
```

### SvelteKit ã®è¨­å®š

`KV` ãŒãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ˜ç¤ºã—ã¾ã™ã€‚

```diff ts:/src/app.d.ts
  // See https://kit.svelte.dev/docs/types#app
  // for information about these interfaces
  declare global {
    namespace App {
      // interface Error {}
      // interface Locals {}
      // interface PageData {}
      // interface PageState {}
-     // interface Platform {}
+     interface Platform {
+       env: {
+         KV: KVNamespace;
+       };
+     }
    }
  }

  export {};
```

ç’°å¢ƒæ§‹ç¯‰ã¯ä»¥ä¸Šã§ã™ï¼

## ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å®Ÿè£…

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ `svelte-kit-sessions` ã®ã‚¬ã‚¤ãƒ‰ã«å¾“ã„ã€hook ã¨ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–å‡¦ç†ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
SvelteKit ã§ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«é–¢é€£ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’ [hooks](https://svelte.dev/docs/kit/hooks) ã¨å‘¼ã³ã¾ã™ã€‚

ã“ã“ã§ã¯ã€hooks ã®ã†ã¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ handle ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

```ts:/src/hooks.server.ts
import type { Handle } from '@sveltejs/kit';
import { sveltekitSessionHandle } from 'svelte-kit-sessions';
import KvStore from 'svelte-kit-connect-cloudflare-kv';
import type { Store } from 'svelte-kit-sessions';

declare module 'svelte-kit-sessions' {
  interface SessionData {
    csrfToken: string;
  }
}

export const handle: Handle = async ({ event, resolve }) => {
  let sessionHandle: Handle | null = null;

  if (event.platform && event.platform.env) {
    // https://kit.svelte.dev/docs/adapter-cloudflare#bindings
    const store = new KvStore({ client: event.platform.env.KV }) as Store;
    sessionHandle = sveltekitSessionHandle({
      secret: 'secret',
      store
    });
  }

  return sessionHandle ? sessionHandle({ event, resolve }) : resolve(event);
};
```

:::message
å‹ã«é–¢ã™ã‚‹ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã€SvelteKit ãŒè‡ªå‹•ç”Ÿæˆã™ã‚‹å‹ãŒç”Ÿæˆã•ã‚Œã¦ã„ãªã„ã“ã¨ã«èµ·å› ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

`npm run dev` ã‚’èµ°ã‚‰ã›ã¦ãŠãã€`npm run build` ã‚’å˜å›å®Ÿè¡Œã™ã‚‹ãªã©ã§å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ›´æ–°ã•ã‚Œã€ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã—ã¾ã™ã€‚

:::

### CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã®ç”Ÿæˆ

`/contact` ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã€ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```diff ts:/src/routes/contact/+page.server.tsï¼ˆæŠœç²‹ï¼‰
- export const load: PageServerLoad = async () => {
+ export const load: PageServerLoad = async ({ locals }) => {
+   const { session } = locals;
+   await session.setData({
+     csrfToken: crypto.randomUUID()
+   });
+   await session.save();
+
    return {
      NAME_MAX_LENGTH,
      EMAIL_MAX_LENGTH,
      CATEGORY_OPTIONS,
-     BODY_MAX_LENGTH
+     BODY_MAX_LENGTH,
+     csrfToken: session.data.csrfToken
+   };
+ };
```

`session.save()` ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ãªã„ã¨ã„ã‘ã¾ã›ã‚“ï¼(1 æ•—)

### schema ã®æ›´æ–°

ã‚‚ã¡ã‚ã‚“ CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«å«ã¾ã‚Œã¾ã™ã€‚

```diff ts:/src/routes/contact/schema.tsï¼ˆæŠœç²‹ï¼‰
  export const requestBodySchema = z.object({
    name: z.string().max(NAME_MAX_LENGTH),
    email: z.string().email().max(EMAIL_MAX_LENGTH),
    category: z.enum(categoryKeys),
    body: z.string().max(BODY_MAX_LENGTH),
+   csrfToken: z.string(),
    reCaptchaToken: z.string()
  });
```

### CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼

æ¤œè¨¼ã«é–¢ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚‚è¨˜è¿°ã—ã¦ãŠãã¾ã™ã€‚

```diff ts:/src/routes/contact/+page.server.tsï¼ˆæŠœç²‹ï¼‰
  export const actions = {
-   default: async ({ request }) => {
+   default: async ({ locals, request }) => {
+     const { session } = locals;
      const rawRequestBody = convertToObject(await request.formData());

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‹ã‘ã‚‹
      const validationResult = requestBodySchema.safeParse(rawRequestBody);
      if (!validationResult.success) {
        return { success: false, message: 'Invalid request body' };
      }
      const requestBody = validationResult.data;
+
+     // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
+     const csrfResult = requestBody.csrfToken === session.data.csrfToken;
+     if (!csrfResult) {
+       return { success: false, message: 'Invalid CSRF token' };
+     }

      // reCAPTCHAã‚’æ¤œè¨¼
      const captchaResult = verifyCaptcha(requestBody.reCaptchaToken);
      if (!captchaResult) {
        return { success: false, message: 'Invalid CAPTCHA token' };
      }

      return { success: true };
    }
  } satisfies Actions;
```

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®å®Ÿè£…

å—ã‘å–ã£ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã€hidden ãª input ã«å…¥ã‚Œã¦ãŠãã ã‘ã§ã™ã€‚

```diff html:/src/routes/conact/+page.svelteï¼ˆæŠœç²‹ï¼‰
    <label>
      æœ¬æ–‡
      <textarea name="body" maxLength={data.BODY_MAX_LENGTH} disabled={isSubmitting}></textarea>
    </label>
+   <input name="csrfToken" type="hidden" value={data.csrfToken} />
    <button type="submit" disabled={isSubmitting}>é€ä¿¡</button>
```

### prerender ã®è§£é™¤

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€prerender ã¯ã§ãã¾ã›ã‚“ã€‚

```diff ts:/src/routes/+page.ts
- export const prerender = true;
```

```diff ts:/src/routes/about/+page.ts
- export const prerender = true;
```

```diff ts:/src/routes/sverdle/how-to-play/+page.ts
- export const prerender = true;
```

```diff ts:/src/routes/+layout.ts
+ export const prerender = false; // ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä¸€æ‹¬æŒ‡å®š
```

## æ¤œè¨¼

### ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ

Cloudflare KV ã¯ Wrangler ãŒãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¦ãã‚Œã¾ã™ã€‚
ãã®ãŸã‚ã€SvelteKit ãŒ Vite ã‚’ç”¨ã„ã¦å®Ÿè¡Œã—ã¦ã„ã‚‹ `npm run dev` ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚

ä¸€åº¦ãƒ“ãƒ«ãƒ‰ã—ã€Wrangler ã«å®Ÿè¡Œã—ã¦ã‚‚ã‚‰ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```shell
npm run build
npx wrangler pages dev ./.svelte-kit/cloudflare/
```

ãã¡ã‚“ã¨ CSRF ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«æ¸¡ã•ã‚Œã€input ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ï¼

![ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã¨ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ„ãƒ¼ãƒ«ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ](/images/create-contact-form-03/01.png)

é€ä¿¡ã™ã‚‹ã¨ã€CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ã«æˆåŠŸã—ã€`success: true` ãŒè¿”ã•ã‚ŒãŸãŸã‚ã€ãƒ•ã‚©ãƒ¼ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚

### ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã€ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒ

ã“ã‚Œã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã€ãã‚Œãã‚Œã®ç’°å¢ƒã§ãã‚Œãã‚Œã®ç’°å¢ƒã® KV ã«æ¥ç¶šã—å‹•ä½œã—ã¾ã™ã€‚
ä¸€æ–¹ã§ã€ãã‚Œãã‚Œã®ç’°å¢ƒã®ä¸­ã§ã¯åŒä¸€ã® KV ã«æ¥ç¶šã™ã‚‹ãŸã‚ã€éå»ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã§ä½œæˆãƒ»ç·¨é›†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å¼•ãç¶™ãã¾ã™ã€‚

Cloudflare ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ KV ã®ãƒšãƒ¼ã‚¸ã«è¡Œãã€å„åå‰ç©ºé–“ã®å†…å®¹ã‚’ç›´æ¥è¦‹ã¦ç¢ºèªã§ãã¾ã™ã€‚
Wrangler çµŒç”±ã§ã‚‚ç¢ºèªã§ãã¾ã™ã€‚

## ãŠã‚ã‚Šã«

ãŸã£ãŸã“ã‚Œã ã‘ã§ Key-Value ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ã¨æ¥ç¶šã§ãã¦ã—ã¾ã†ï¼ãªã‚“ã¨ä¾¿åˆ©ãªæ™‚ä»£ãªã®ã§ã—ã‚‡ã†ã‹ã€‚

æ¬¡å›ã® Cloudflare D1 ã‚‚åŸºæœ¬çš„ãªé€£æºæ–¹æ³•ã¯åŒã˜ã§ã™ã€‚
ORM ã‚‚äº¤ã‚ã‚‹ã€ã‚ˆã‚Šæ·±ãä¾¿åˆ©ãªä¸–ç•Œã¸é€²ã‚“ã§ã„ãã¾ã™ï¼

---

1. [â‘  ã‚µã‚¤ãƒˆä½œæˆï¼šSvelteKit x Cloudflare Pages](https://zenn.dev/orch_canvas/articles/create-contact-form-01)
1. [â‘¡ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆï¼šSvelteKit x Zod x Google reCAPTCHA v3](https://zenn.dev/orch_canvas/articles/create-contact-form-02)
1. â‘¢ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼šSvelteKit x Cloudflare KV
1. **[â‘£ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ï¼šSvelteKit x Cloudflare D1 â† æ¬¡ã®è¨˜äº‹](https://zenn.dev/orch_canvas/articles/create-contact-form-04)**
1. [â‘¤ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼šSvelteKit x Resend](https://zenn.dev/orch_canvas/articles/create-contact-form-05)

---

<!-- begin long upcoming concert announcement -->

## æ¬¡å›æ¼”å¥ä¼šã®ã”æ¡ˆå†…

Orchestra Canvas Tokyoã¯ã€éƒ½å†…ã‚’ä¸­å¿ƒã«æ´»å‹•ã™ã‚‹ã‚¢ãƒãƒãƒ¥ã‚¢ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©ã§ã™ã€‚

æ—¥ã€…ã®ç™’ã—ã«ã€æ–°ãŸãªã²ã‚‰ã‚ãã®ãã£ã‹ã‘ã«â€”â€”
ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©ã®æ¼”å¥ä¼šã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼Ÿ

åˆã‚ã¦ã®æ–¹ã‚‚å¤§æ­“è¿ï¼
ã”æ¥å ´ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚

> **Orchestra Canvas Tokyo**
> **ç¬¬16å›å®šæœŸæ¼”å¥ä¼š**
>
> 2026å¹´3æœˆ15æ—¥(æ—¥)
> åºœä¸­ã®æ£®èŠ¸è¡“åŠ‡å ´ ã©ã‚Šãƒ¼ã‚€ãƒ›ãƒ¼ãƒ«
> ãƒãƒ¼ãƒ³ã‚¹ã‚¿ã‚¤ãƒ³ / ã€Œã‚¦ã‚§ã‚¹ãƒˆã‚µã‚¤ãƒ‰ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã€ã‚ˆã‚Šã‚·ãƒ³ãƒ•ã‚©ãƒ‹ãƒƒã‚¯ãƒ€ãƒ³ã‚¹ ã»ã‹
>
> è©³ç´°ã¯[ãƒã‚±ãƒƒãƒˆè²©å£²ãƒšãƒ¼ã‚¸](https://teket.jp/1776/59938?uid=zenn)ã«ã¦

<!-- end long upcoming concert announcement -->
